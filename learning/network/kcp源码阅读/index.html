<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="XqWEZ-KjvQT4IfXzxYvH-PEc--_zN6GqthY2jBsqOs4"><meta name="msvalidate.01" content="4E28E3FDD5912EBBB84869B17359650D"><meta name="baidu-site-verification" content="code-dwpSTDBLS2"><link rel="alternate" type="application/rss+xml" title="é‘«é…±" href="https://hakuya.me/rss.xml"><link rel="alternate" type="application/atom+xml" title="é‘«é…±" href="https://hakuya.me/atom.xml"><link rel="alternate" type="application/json" title="é‘«é…±" href="https://hakuya.me/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="kcp,net"><link rel="canonical" href="https://hakuya.me/learning/network/kcp%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><title>kcpæºç é˜…è¯» - è®¡ç®—æœºç½‘ç»œ - å­¦ä¹  | ä¸ªäººåšå®¢ = é‘«é…± = ç¬”è®°æœ¬</title><meta name="generator" content="Hexo 6.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">kcpæºç é˜…è¯»</h1><div class="meta"><span class="item" title="åˆ›å»ºæ—¶é—´ï¼š2022-02-23 16:26:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">å‘è¡¨äº</span> <time itemprop="dateCreated datePublished" datetime="2022-02-23T16:26:00+08:00">2022-02-23</time> </span><span class="item" title="æœ¬æ–‡å­—æ•°"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">æœ¬æ–‡å­—æ•°</span> <span>12k</span> <span class="text">å­—</span> </span><span class="item" title="é˜…è¯»æ—¶é•¿"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">é˜…è¯»æ—¶é•¿</span> <span>11 åˆ†é’Ÿ</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ä¸ªäººåšå®¢</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://wallpaper-1255596461.cos.ap-nanjing.myqcloud.com/wallpaper (19).jpg"></li><li class="item" data-background-image="https://wallpaper-1255596461.cos.ap-nanjing.myqcloud.com/wallpaper_6.jpg"></li><li class="item" data-background-image="https://wallpaper-1255596461.cos.ap-nanjing.myqcloud.com/wallpaper (9).jpg"></li><li class="item" data-background-image="https://wallpaper-1255596461.cos.ap-nanjing.myqcloud.com/wallpaper (16).jpg"></li><li class="item" data-background-image="https://wallpaper-1255596461.cos.ap-nanjing.myqcloud.com/wallpaper (3).jpg"></li><li class="item" data-background-image="https://wallpaper-1255596461.cos.ap-nanjing.myqcloud.com/wallpaper (24).jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">é¦–é¡µ</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/learning/" itemprop="item" rel="index" title="åˆ†ç±»äº å­¦ä¹ "><span itemprop="name">å­¦ä¹ </span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/learning/network/" itemprop="item" rel="index" title="åˆ†ç±»äº è®¡ç®—æœºç½‘ç»œ"><span itemprop="name">è®¡ç®—æœºç½‘ç»œ</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://hakuya.me/learning/network/kcp%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="é‘«é…±(â—'â—¡'â—)"><meta itemprop="description" content="ç¬”è®°æœ¬, æ•´å¤©æ‘¸é±¼ï¼Œå´å¦„æƒ³æ‹¯æ•‘ä¸–ç•Œçš„æŠ€æœ¯å®…"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="é‘«é…±"></span><div class="body md" itemprop="articleBody"><div class="note info"><p>ä»¥ä¸‹ä¸ºä¸ªäººå­¦ä¹ ç¬”è®°æ•´ç†ã€‚é¡¹ç›®æºç æ¥è‡ª <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NreXdpbmQzMDAwL2tjcA==">kcp github å¼€æºåº“</span></p></div><h1 id="kcpæºç é˜…è¯»"><a class="anchor" href="#kcpæºç é˜…è¯»">#</a> kcp æºç é˜…è¯»</h1><h2 id="æ”¶å‘åŒ…æµç¨‹"><a class="anchor" href="#æ”¶å‘åŒ…æµç¨‹">#</a> æ”¶å‘åŒ…æµç¨‹</h2><p>Kcp æ¡æ‰‹ | æŒ¥æ‰‹ è§„åˆ™å…¶å®æ˜¯ä¸Šå±‚åº”ç”¨è‡ªå·±å®šä¹‰çš„ï¼Œå› æ­¤å®ç°ä¸Šäº”èŠ±å…«é—¨ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p><ul><li><p>Kcp æ¡æ‰‹ï¼š</p><ul><li>å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥ï¼ŒæœåŠ¡å™¨åˆ›å»º kcp å¯¹è±¡ï¼Œç”Ÿæˆ conv ç¼–å·ï¼Œé€šçŸ¥å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯é€šè¿‡ conv åˆå§‹åŒ– kcpï¼ŒåŒç«¯ conv ä¸€è‡´ï¼Œå¼€å§‹é€šä¿¡</li><li>ç‰¹æ®Šæƒ…å†µï¼š<ul><li>å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ä¸¢å¤±ï¼šå®¢æˆ·ç«¯æœªæ”¶åˆ° conv è§¦å‘é‡ä¼ </li><li>æœåŠ¡å™¨åŒæ­¥ conv ä¸¢å¤±ï¼šåŒç†ï¼Œå®¢æˆ·ç«¯è§¦å‘é‡ä¼ å†æ¬¡å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨å†æ¬¡ç”Ÿæˆ conv å¹¶åŒæ­¥</li><li>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚åæ–­å¼€ï¼ˆæœªé€šçŸ¥æœåŠ¡å™¨ï¼‰ï¼šæœåŠ¡å™¨ kcp å¯¹è±¡è¿‡ä¿æ´»æœŸï¼Œç›´æ¥é”€æ¯</li></ul></li></ul></li><li><p>Kcp æŒ¥æ‰‹ã€‚æŒ¥æ‰‹æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯éæ­£å¸¸æŒ¥æ‰‹ï¼Œä¸€ç§æ˜¯æ­£å¸¸æŒ¥æ‰‹ï¼š</p><ul><li><p>éæ­£å¸¸æŒ¥æ‰‹ã€‚å³è‡ªå·±æ–­å¼€åæœªé€šçŸ¥å¯¹ç«¯</p><ul><li>å®¢æˆ·ç«¯ç½‘ç»œæ–­å¼€ï¼šæœåŠ¡å™¨æ”¶ä¸åˆ°æ–­å¼€è¯·æ±‚ï¼Œå¿ƒè·³ç»“æŸåä¸»åŠ¨é”€æ¯ kcpï¼Œå¯ä»¥è€ƒè™‘é¢å¤–ä¸»æ¨ä¸€æ¬¡æ–­å¼€è¯·æ±‚ç»™å®¢æˆ·ç«¯ï¼Œé¿å…ä¸´æ—¶æ–­ç½‘å¯¼è‡´å®¢æˆ·ç«¯æ— æ³•é‡è¿</li><li>å®¢æˆ·ç«¯åº”ç”¨è¢«æ€ï¼šåŒä¸Š</li><li>æœåŠ¡å™¨å®•æœºï¼šå®¢æˆ·ç«¯å¿ƒè·³å¤±æ´»ï¼Œä¸€èˆ¬è€ƒè™‘é‡è¿ or é€€å‡º</li></ul></li><li><p>æ­£å¸¸æŒ¥æ‰‹ã€‚è‡ªèº«æ–­å¼€å‰å…ˆé€šçŸ¥å¯¹ç«¯</p><ul><li>å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚æ–­å¼€ï¼šæœåŠ¡å™¨æ”¶åˆ°ä¸»åŠ¨æ–­å¼€åï¼Œæ¸…ç†ç¼“å­˜æ•°æ®å¹¶æ¨é€æ–­å¼€æ•°æ®åŒ…åé”€æ¯ kcp å¯¹è±¡ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°ä¸»åŠ¨æ–­å¼€å›åŒ…åå¤„ç†æ–­å¼€é€»è¾‘ï¼Œæ­£å¸¸å…³é—­ã€‚</li><li>æœåŠ¡å™¨å¼ºåˆ¶è¸¢å®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æ–­å¼€è¯·æ±‚åï¼Œå¼ºåˆ¶é”€æ¯ kcpï¼Œæ­£å¸¸å…³é—­ã€‚</li></ul></li><li><p>ç‰¹æ®Šæƒ…å†µï¼š</p><ul><li>å®¢æˆ·ç«¯å‘é€æ–­å¼€è¯·æ±‚ä¸¢å¤±ï¼šèµ°è¶…æ—¶é‡ä¼ æˆ–è€…ç›´æ¥å¼ºæ€éƒ½è¡Œï¼Œåæ­£æœåŠ¡å™¨ä¿æ´»åˆ°äº†ä¹Ÿä¼šæ¸…ç† kcp</li><li>æœåŠ¡å™¨æ¨é€æ–­å¼€åŒ…ä¸¢å¤±ï¼šåŒç†ï¼Œå¿ƒè·³åŒ…å¤±æ´»ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€æˆ–è€…é‡è¿</li></ul></li></ul></li></ul><p>Kcp æœ¬èº«çš„ç»†èŠ‚å…¶å®æŒºå¤šï¼Œä¾‹å¦‚é‡è¿éœ€ä¸éœ€è¦å•ç‹¬ä¸€ç§åŒ…ç±»å‹ç”¨æ¥åŒºåˆ†ï¼Œè¿˜æ˜¯é»˜è®¤å‘é€æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå¦‚æœåŒç«¯ kcp éƒ½ä¿æ´»ï¼ˆä½†å¿ƒè·³å¼‚å¸¸ï¼‰æƒ…å†µä¸‹ç›´æ¥é‡è¿ï¼›å¦‚æœæ–­å¼€è¿æ¥åä¾æ—§æ”¶åˆ°äº†å¯¹ç«¯çš„æ•°æ®åŒ…å¦‚ä½•å¤„ç†ï¼›å¦‚æœç”±äºè¶…æ—¶å‘èµ·äº†å¤šæ¬¡è¿æ¥è¯·æ±‚ï¼Œæ”¶åˆ°äº†å¤šä¸ª conv ç¼–å·æƒ…å†µä¸‹çš„å¤„ç†ï¼Œè¿™äº›é—®é¢˜éƒ½æ˜¯æŒºå€¼å¾—æ€è€ƒçš„ã€‚ğŸ¤”</p><p>æ•°æ®åŒ…å¤„ç†åŒç«¯éƒ½åŸºæœ¬ä¸€è‡´ï¼Œé€šè¿‡ update æœºåˆ¶ä¸€æ®µæ—¶é—´å¤„ç†ä¸€æ¬¡å‘åŒ…ï¼Œæ›´æ–° <code>buf</code> å’Œ <code>ack</code> ï¼Œåˆ¤æ–­å¿«ä¼ å’Œé‡ä¼ æ›´æ–°çª—å£å¤§å°ã€‚</p><p>æ”¶åŒ…èµ° <code>boost asio</code> çš„ <code>socket</code> å›è°ƒ <code>async_receive_from</code> ï¼Œä» <code>socket</code> å†…è¯»å–æ•°æ®åˆ° <code>kcp buffer</code> å¹¶æ‰§è¡Œç”¨äºå®šä¹‰çš„å›è°ƒå‡½æ•°è¿›è¡Œå¤„ç†ï¼š</p><ul><li>æ›´æ–° <code>ack_list</code> ï¼Œç”¨äºä¸‹æ¬¡ <code>flush</code> çš„æ—¶å€™å›åŒ…ã€‚</li><li>å¹¶å°è¯•è¯»å– <code>kcp buffer</code> æ•°æ®ï¼Œå¦‚æœæ•°æ®ä¸å®Œæ•´å°±ç­‰ä¸‹ä¸€ä¸ªåŒ…æ•°æ®ï¼Œå¹¶ç»§ç»­ç›‘å¬ <code>socket</code></li><li>å¦‚æœæ•°æ®èƒ½å¤Ÿè¯»å–å‡ºæ¥ï¼Œåˆ™è¯»å–ã€è§£åŒ…åï¼Œé€åˆ°ä¸Šå±‚é€»è¾‘å¤„ç†ï¼Œå¹¶ç»§ç»­ç›‘å¬ <code>socket</code></li></ul><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220223153933.png" alt="image-20220223153932659"></p><h2 id="ç›¸å…³æ•°æ®ç»“æ„"><a class="anchor" href="#ç›¸å…³æ•°æ®ç»“æ„">#</a> ç›¸å…³æ•°æ®ç»“æ„</h2><h3 id="kcpåŒ…å¤´"><a class="anchor" href="#kcpåŒ…å¤´">#</a> Kcp åŒ…å¤´</h3><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220223145344.png" alt="image-20220223145332492"></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// è§£åŒ…ä»£ç ï¼Œå‹åŒ…åŒç†</span></pre></td></tr><tr><td data-num="2"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode32u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>conv<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode8u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode8u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode16u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wnd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode32u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode32u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode32u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>una<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>data <span class="token operator">=</span> <span class="token function">ikcp_decode32u</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// data copy</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">memcpy</span><span class="token punctuation">(</span>seg<span class="token operator">-></span>data<span class="token punctuation">,</span> data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="æœ¬åœ°kcp-segmentç»“æ„"><a class="anchor" href="#æœ¬åœ°kcp-segmentç»“æ„">#</a> æœ¬åœ° Kcp Segment ç»“æ„</h3><p>åŒ…ä½“åœ¨å†…å­˜ä¸­çš„ç»„ç»‡å½¢å¼ï¼š</p><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220221150024.png" alt="image-20220221150023054"></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">IKCPSEG</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	IUINT32 conv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	IUINT32 cmd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	IUINT32 frg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	IUINT32 wnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	IUINT32 ts<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	IUINT32 sn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	IUINT32 una<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	IUINT32 len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	IUINT32 resendts<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	IUINT32 rto<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	IUINT32 fastack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	IUINT32 xmit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	IUINT8  reliable<span class="token punctuation">;</span>   <span class="token comment">// å®šåˆ¶å­—æ®µï¼Œå®ç°äº†éƒ¨åˆ†æ•°æ®å¯ä»¥éå¯é æœºåˆ¶</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="kcp-å¯¹è±¡æ•°æ®ç»“æ„"><a class="anchor" href="#kcp-å¯¹è±¡æ•°æ®ç»“æ„">#</a> Kcp å¯¹è±¡æ•°æ®ç»“æ„</h3><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220221172234.png" alt="image-20220221172232658"></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">IKCPCB</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	IUINT32 conn_id<span class="token punctuation">;</span> <span class="token comment">// å¤–éƒ¨è®¾ç½®çš„å”¯ä¸€æ ‡è¯†</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	IUINT32 conv<span class="token punctuation">,</span> mtu<span class="token punctuation">,</span> mss<span class="token punctuation">,</span> state<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	IUINT32 snd_una<span class="token punctuation">,</span> snd_nxt<span class="token punctuation">,</span> rcv_nxt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	IUINT32 ts_recent<span class="token punctuation">,</span> ts_lastack<span class="token punctuation">,</span> ssthresh<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	IINT32 rx_rttval<span class="token punctuation">,</span> rx_srtt<span class="token punctuation">,</span> rx_rto<span class="token punctuation">,</span> rx_minrto<span class="token punctuation">,</span> rx_rttval_ratio<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	IUINT32 snd_wnd<span class="token punctuation">,</span> rcv_wnd<span class="token punctuation">,</span> rmt_wnd<span class="token punctuation">,</span> cwnd<span class="token punctuation">,</span> probe<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	IUINT32 current<span class="token punctuation">,</span> interval<span class="token punctuation">,</span> ts_flush<span class="token punctuation">,</span> xmit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	IUINT32 nrcv_buf<span class="token punctuation">,</span> nsnd_buf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	IUINT32 nrcv_que<span class="token punctuation">,</span> nsnd_que<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	IUINT32 nodelay<span class="token punctuation">,</span> updated<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	IUINT32 ts_probe<span class="token punctuation">,</span> probe_wait<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	IUINT32 dead_link<span class="token punctuation">,</span> incr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> snd_queue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> rcv_queue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> snd_buf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">IQUEUEHEAD</span> rcv_buf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	IUINT32 <span class="token operator">*</span>acklist<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	IUINT32 ackcount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	IUINT32 ackblock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token keyword">char</span> <span class="token operator">*</span>unrel_buffer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token keyword">int</span> fastresend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token keyword">int</span> nocwnd<span class="token punctuation">,</span> stream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">int</span> logmask<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>output<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">IKCPCB</span> <span class="token operator">*</span>kcp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>writelog<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>log<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">IKCPCB</span> <span class="token operator">*</span>kcp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="æ ¸å¿ƒæ¥å£"><a class="anchor" href="#æ ¸å¿ƒæ¥å£">#</a> æ ¸å¿ƒæ¥å£</h2><h3 id="ikcp_create"><a class="anchor" href="#ikcp_create">#</a> ikcp_create</h3><p>åˆ›å»ºä¸€ä¸ª kcp é“¾æ¥ï¼Œå‘èµ·ç«¯ä¼šæ„å»ºä¸€ä¸ªéšæœºæ•° <code>conv</code> ç”¨æ¥å”¯ä¸€æ ‡è¯†ï¼ŒåŒç«¯çš„ <code>conv</code> ä¸€è‡´æ‰å¯ä»¥æ­£å¸¸çš„å¤„ç†æ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>ikcpcb<span class="token operator">*</span> <span class="token function">ikcp_create</span><span class="token punctuation">(</span>IUINT32 conv<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> IUINT32 conn_id<span class="token punctuation">,</span> IUINT32 sys_current<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	ikcpcb <span class="token operator">*</span>kcp <span class="token operator">=</span> <span class="token punctuation">(</span>ikcpcb<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ikcp_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">IKCPCB</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// init kcp args</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// init buffer</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	kcp<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ikcp_malloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>mtu <span class="token operator">+</span> IKCP_OVERHEAD<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token function">ikcp_free</span><span class="token punctuation">(</span>kcp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    </pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">// init kcp args</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">return</span> kcp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="ikcp_setoutput-kcp-output-ikcp_output"><a class="anchor" href="#ikcp_setoutput-kcp-output-ikcp_output">#</a> ikcp_setoutput | kcp-&gt;output | ikcp_output</h3><p>kcp çš„æ•°æ®å‘é€æ¥å£ï¼Œè°ƒç”¨ä¹‹åé»˜è®¤è§†ä½œæ•°æ®åŒ…å·²ç»å‘é€ã€‚</p><p>å¯ä»¥é€šè¿‡ <code>ikcp_setoutput</code> æ¥è‡ªå®šä¹‰ <code>kcp-&gt;output</code> æ“ä½œã€‚</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// output segment</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ikcp_output</span><span class="token punctuation">(</span>ikcpcb <span class="token operator">*</span>kcp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token function">assert</span><span class="token punctuation">(</span>kcp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token function">assert</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>output<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ikcp_canlog</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> IKCP_LOG_OUTPUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token function">ikcp_log</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> IKCP_LOG_OUTPUT<span class="token punctuation">,</span> <span class="token string">"[RO] %ld bytes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	kcp<span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> size<span class="token punctuation">,</span> kcp<span class="token punctuation">,</span> kcp<span class="token operator">-></span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="ikcp_update"><a class="anchor" href="#ikcp_update">#</a> ikcp_update</h3><p>å®šæ—¶è¿›è¡Œè°ƒç”¨ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ <code>ikcp_flush</code> ã€‚</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// update state (call it repeatedly, every 10ms-100ms), or you can ask </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// ikcp_check when to call it again (without ikcp_input/_send calling).</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 'current' - current timestamp in millisec. </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token function">ikcp_update</span><span class="token punctuation">(</span>ikcpcb <span class="token operator">*</span>kcp<span class="token punctuation">,</span> IUINT32 current<span class="token punctuation">,</span> IUINT32 sys_current<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	IINT32 slap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	kcp<span class="token operator">-></span>current <span class="token operator">=</span> current<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>updated <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		kcp<span class="token operator">-></span>updated <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		kcp<span class="token operator">-></span>ts_flush <span class="token operator">=</span> kcp<span class="token operator">-></span>current<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>	slap <span class="token operator">=</span> <span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>current<span class="token punctuation">,</span> kcp<span class="token operator">-></span>ts_flush<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>slap <span class="token operator">>=</span> <span class="token number">10000</span> <span class="token operator">||</span> slap <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		kcp<span class="token operator">-></span>ts_flush <span class="token operator">=</span> kcp<span class="token operator">-></span>current<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		slap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>slap <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		kcp<span class="token operator">-></span>ts_flush <span class="token operator">+=</span> kcp<span class="token operator">-></span>interval<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>current<span class="token punctuation">,</span> kcp<span class="token operator">-></span>ts_flush<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>			kcp<span class="token operator">-></span>ts_flush <span class="token operator">=</span> kcp<span class="token operator">-></span>current <span class="token operator">+</span> kcp<span class="token operator">-></span>interval<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token function">ikcp_flush</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> sys_current<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="ikcp_flush"><a class="anchor" href="#ikcp_flush">#</a> ikcp_flush</h3><p>å‘é€ä¹‹å‰æ‰“åŒ…å¥½å¾…å‘é€çš„æ•°æ®åŒ…ï¼š</p><ul><li>åŒæ­¥ä¹‹å‰æ”¶åˆ°åŒ…çš„ <code>ack</code> ä¿¡æ¯</li><li>ã€å¯é€‰ã€‘å°è¯•è¯·æ±‚å¯¹ç«¯çª—å£å¤§å°</li><li>ã€å¯é€‰ã€‘å°è¯•å›å¤å¯¹ç«¯çª—å£è¯·æ±‚</li><li>è®¡ç®—æ‰€éœ€å‘é€çš„åŒ…ä½“æ•°æ®å¹¶å‘åŒ…ï¼š<ul><li>å‘é€éå¯é åŒ…</li><li>å‘é€æ­£å¸¸åŒ…</li><li>å‘é€è¶…æ—¶åŒ…</li><li>å‘é€é‡ä¼ åŒ…</li></ul></li><li>æ ¹æ®å‘é€çš„åŒ…ä½“ç§ç±»æ›´æ–°å„é¡¹å‚æ•°ï¼ˆæ‹¥å¡æ§åˆ¶ã€æ…¢å¯åŠ¨ï¼‰</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// ikcp_flush</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">ikcp_flush</span><span class="token punctuation">(</span>ikcpcb <span class="token operator">*</span>kcp<span class="token punctuation">,</span> IUINT32 sys_current<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">// 'ikcp_update' haven't been called. </span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>updated <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">// ã€step.1ã€‘é€šçŸ¥ä¸Šä¸€æ¬¡ flush è‡³ä»Šæ”¶åˆ°çš„æ‰€æœ‰åŒ…çš„ ack ä¿¡æ¯</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kcp<span class="token operator">-></span>ackcount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token comment">// å°è¯•å’ŒåŒ…å¹¶å‘åŒ…</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    </pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">// ã€step.2ã€‘è®¾ç½®ä¸‹ä¸€æ¬¡æ¢æŸ¥å¯¹ç«¯çš„çª—å£å¤§å°çš„æ—¶é—´ç‚¹</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>rmt_wnd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>probe_wait <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>current<span class="token punctuation">,</span> kcp<span class="token operator">-></span>ts_probe<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token comment">//...</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                kcp<span class="token operator">-></span>probe <span class="token operator">|=</span> IKCP_ASK_SEND<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token comment">// ã€step.2.1ã€‘æ»¡è¶³æ¢æŸ¥æ¡ä»¶ä¼šæä¸Šä¸€ä¸ªæ¢æŸ¥åŒ…ï¼Œé€šçŸ¥å¯¹ç«¯å‘é€çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>probe <span class="token operator">&amp;</span> IKCP_ASK_SEND<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token comment">//...</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">// ã€step.2.2ã€‘å‘é€æ¢æŸ¥å›å¤åŒ…ï¼Œé€šçŸ¥å¯¹ç«¯è‡ªèº«çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// åœ¨ ikcp_recv ä¸­è®¾ç½®è¯¥æ ‡è®°ï¼Œç”¨äºå¿«é€Ÿé€šçŸ¥å¯¹ç«¯è‡ªèº«çª—å£æœ‰ç©ºä½™ï¼Œå¯ä»¥å¼€å§‹å‘åŒ…äº†</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>probe <span class="token operator">&amp;</span> IKCP_ASK_TELL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token comment">//...</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// ã€step.3ã€‘å°è¯•å‘é€æ•°æ®åŒ…</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token comment">// ã€step.3.1ã€‘è®¡ç®—æ‹¥å¡çª—å£å¤§å°ï¼Œè¡¨ç¤ºå¯¹ç«¯è¿˜èƒ½æ¥æ”¶åˆ°çš„æœ€å¤§åŒ…æ•°é‡</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	cwnd <span class="token operator">=</span> <span class="token function">_imin_</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>snd_wnd<span class="token punctuation">,</span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>nocwnd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> cwnd <span class="token operator">=</span> <span class="token function">_imin_</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd<span class="token punctuation">,</span> cwnd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token comment">// ã€step.3.2ã€‘æŠŠéœ€è¦å‘é€çš„æ•°æ®åŒ…åŠ å…¥å‘é€é˜Ÿåˆ—</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>snd_nxt<span class="token punctuation">,</span> kcp<span class="token operator">-></span>snd_una <span class="token operator">+</span> cwnd<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>		<span class="token comment">// 1 ~ 10   ~    15    16</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// ---------------</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// | ack | unack |   snd_nxt</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">// ---------------</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">//       |         cwnd = 20       |</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">//               |  send cnt = 15  |</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token comment">// æ ¸å¿ƒæ€æƒ³ï¼šæ‹¥å¡çª—å£å¤§å°ï¼ˆcwndï¼‰ = æœ¬ç«¯å·²å‘é€å¯¹ç«¯æœªæ”¶åˆ°ï¼ˆunackï¼‰ + æœ¬æ¬¡å‘é€ï¼ˆï¼‰</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token comment">// ã€step.3.3ã€‘è®¡ç®—å¿«é€Ÿé‡ä¼ é˜ˆå€¼ï¼Œè¶…è¿‡è¯¥å€¼è§¦å‘é‡ä¼ </span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">// ä¾‹å¦‚ resent = 3ï¼Œåƒå¯¹ç«¯å‘é€ 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5 åŒ…</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">// æ”¶åˆ°äº† 2 å·åŒ…çš„ ackï¼Œé‚£ä¹ˆ 1 å·åŒ…å°±ç®—ä½œ fastack + 1</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">//fastack >= resent å°è¯•è§¦å‘ã€Œå¿«é€Ÿé‡ä¼ ã€ä¸å†ç­‰è¶…æ—¶äº†</span></pre></td></tr><tr><td data-num="55"></td><td><pre>	resent <span class="token operator">=</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>fastresend <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">(</span>IUINT32<span class="token punctuation">)</span>kcp<span class="token operator">-></span>fastresend <span class="token operator">:</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token comment">// ã€step.3.4ã€‘è®¾ç½®è¶…æ—¶é‡ä¼ çš„è®¡ç®—è§„åˆ™</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    rtomin <span class="token operator">=</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>nodelay <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>rx_rto <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token comment">// ã€step.3.5ã€‘å¼€å§‹è¯»å–ç¼“å­˜é˜Ÿåˆ—çš„æ•°æ®è¿›è¡Œå‘åŒ…</span></pre></td></tr><tr><td data-num="60"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> kcp<span class="token operator">-></span>snd_buf<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token operator">&amp;</span>kcp<span class="token operator">-></span>snd_buf<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>		IKCPSEG <span class="token operator">*</span>segment <span class="token operator">=</span> <span class="token function">iqueue_entry</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> IKCPSEG<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>		<span class="token keyword">int</span> needsend <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token comment">// ã€step.3.5.1ã€‘éå¯é åŒ…ç‰¹æ®Šå¤„ç†ï¼Œä¸æ”¾å…¥ ack_list ä¹Ÿä¸è®¡ç®—é‡ä¼ æ—¶é—´</span></pre></td></tr><tr><td data-num="65"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token operator">-></span>cmd <span class="token operator">==</span> IKCP_CMD_UNRELIABLE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>			<span class="token comment">// ...</span></pre></td></tr><tr><td data-num="67"></td><td><pre>			<span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token comment">// ã€step.3.5.2ã€‘è®¡ç®—éœ€è¦é‡ä¼ çš„åŒ…ä½“</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token comment">// éé‡ä¼ åŒ…åˆå§‹åŒ–å„é¡¹å‚æ•°ï¼Œé‡ä¼ æ—¶é—´ï¼Œé‡ä¼ æ¬¡æ•°...</span></pre></td></tr><tr><td data-num="72"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token operator">-></span>xmit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>			<span class="token comment">//...</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            needsend <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token comment">// ã€Œè¶…æ—¶é‡ä¼ ã€æ›´æ–°å„é¡¹å‚æ•°ï¼Œé‡ä¼ æ—¶é—´ï¼Œé‡ä¼ æ¬¡æ•°...</span></pre></td></tr><tr><td data-num="77"></td><td><pre>		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> segment<span class="token operator">-></span>resendts<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>			needsend <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            lost <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// è®°å½•å‡ºç°äº†æŠ¥æ–‡ä¸¢å¤±</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token comment">//...</span></pre></td></tr><tr><td data-num="81"></td><td><pre>			<span class="token comment">// æ ¹æ® nodelay é‡æ–°è®¡ç®—ä¸‹æ¬¡é‡ä¼ æ—¶é—´</span></pre></td></tr><tr><td data-num="82"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>nodelay <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                segment<span class="token operator">-></span>rto <span class="token operator">+=</span> kcp<span class="token operator">-></span>rx_rto<span class="token punctuation">;</span> <span class="token comment">//tcp è§„åˆ™ 2 å€å¢é•¿</span></pre></td></tr><tr><td data-num="84"></td><td><pre>			<span class="token keyword">else</span> </pre></td></tr><tr><td data-num="85"></td><td><pre>                segment<span class="token operator">-></span>rto <span class="token operator">+=</span> kcp<span class="token operator">-></span>rx_rto <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// å¿«ä¼ æ–¹å¼ 1.5 å€å¢é•¿</span></pre></td></tr><tr><td data-num="86"></td><td><pre>			segment<span class="token operator">-></span>resendts <span class="token operator">=</span> current <span class="token operator">+</span> segment<span class="token operator">-></span>rto<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token comment">// ã€Œå¿«é€Ÿé‡ä¼ ã€æ ¹æ®åç½®ä¸¢åŒ…æ•°ï¼Œå¿«é€Ÿè¿›è¡Œé‡ä¼ </span></pre></td></tr><tr><td data-num="89"></td><td><pre>		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token operator">-></span>fastack <span class="token operator">>=</span> resent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>			needsend <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            change<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// æ ‡è¯†å¿«é‡ä¼ å‘ç”Ÿ</span></pre></td></tr><tr><td data-num="92"></td><td><pre>			<span class="token comment">//...</span></pre></td></tr><tr><td data-num="93"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>needsend<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>			<span class="token comment">// åˆåŒ…å¹¶å‘åŒ…</span></pre></td></tr><tr><td data-num="97"></td><td><pre>	</pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token comment">// è®°å½•æœ¬æ¬¡å‘é€çš„ Segment æ•°é‡</span></pre></td></tr><tr><td data-num="99"></td><td><pre>            </pre></td></tr><tr><td data-num="100"></td><td><pre>            <span class="token comment">// è¶…è¿‡æœ€å¤§é‡ä¼ æ¬¡æ•°ï¼Œè¡¨ç¤ºç½‘ç»œå¯èƒ½å‡ºç°æ•…éšœï¼Œç›´æ¥æ–­å¼€è¿æ¥</span></pre></td></tr><tr><td data-num="101"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token operator">-></span>xmit <span class="token operator">>=</span> kcp<span class="token operator">-></span>dead_link<span class="token punctuation">)</span> kcp<span class="token operator">-></span>state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre>	<span class="token comment">//ã€step.3.5.3ã€‘æŠŠå‰©ä½™æ®‹ç•™æœªå‡‘æˆæ»¡åŒ…çš„æ•°æ®å‘é€ï¼ˆåˆåŒ…åå‰©ä¸‹çš„æ®‹æ¸£ï¼‰</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>	<span class="token comment">//ã€step.3.6ã€‘æ¸…ç†æ‰ç¼“å­˜æ•°æ®å†…çš„ã€Œéå¯é åŒ…ã€ï¼Œå› ä¸ºä¸éœ€è¦è®°å½• ack äº†</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>	<span class="token comment">// ã€step.3.7ã€‘è§¦å‘å¿«é€Ÿé‡ä¼ ï¼Œéœ€è¦è°ƒæ•´æ‹¥å¡çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="110"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="112"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token comment">// ã€step.3.8ã€‘è§¦å‘äº†è¶…æ—¶é‡ä¼ ï¼Œéœ€è¦è°ƒæ•´æ‹¥å¡çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="115"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>lost<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>		<span class="token comment">// ...</span></pre></td></tr><tr><td data-num="117"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="ikcp_input"><a class="anchor" href="#ikcp_input">#</a> ikcp_input</h3><p>è¾“å…¥æ•°æ®æ˜¯é€šè¿‡ç³»ç»Ÿå±‚çš„ <code>UDP</code> ä¼ è¾“æœºåˆ¶å‘å›çš„ <code>KCP</code> åŒ…ã€‚</p><p>é€šè¿‡ <code>ikcp_input</code> æ¥å£å¤„ç†ä¸åŒç±»å‹çš„åŒ…ä½“æ¥å®ç° <code>KCP</code> é€»è¾‘ï¼š</p><ul><li>ä¿è¯å¯é æ€§é€»è¾‘ï¼ˆé‡ä¼ æœºåˆ¶ï¼‰</li><li>çª—å£å¤§å°è¯·æ±‚ç­‰è§„åˆ™</li><li>æŠŠæ”¶åˆ°çš„æ•°æ®è§„èŒƒåŒ–ï¼Œå¸¦æœ‰ <code>Segment</code> å¤´ä¿¡æ¯ï¼Œå¹¶åŠ å…¥ <code>rev_buf</code> ï¼ˆæ— åºï¼‰</li><li>æ ¹æ® <code>sn</code> å†å¯¹ <code>rev_buf</code> å†…çš„ <code>Segment</code> è¿›è¡Œæ’åºå¹¶æ”¾å…¥åˆ° <code>rev_queue</code> ï¼ˆæœ‰åºï¼‰</li><li>ä¸ºåç»­ <code>ikcp_recv</code> æ“ä½œåšå‡†å¤‡</li></ul><p>å¦‚ä¸‹æ˜¯ä¸€ä¸ª <code>PUSH</code> åŒ…çš„éƒ¨åˆ†æµç¨‹ï¼š</p><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220222152801.png" alt="image-20220222152800500"></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// input data</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">ikcp_input</span><span class="token punctuation">(</span>ikcpcb <span class="token operator">*</span>kcp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//ã€step.1ã€‘è§£ kcp åŒ…</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">//ã€step.1.1ã€‘æ£€æŸ¥ conv å€¼</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>conv <span class="token operator">!=</span> kcp<span class="token operator">-></span>conv<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">//ã€step.1.2ã€‘è§£ kcp åŒ…å¤´ï¼Œè·å–åŒ…ä½“ç±»å‹</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">//ã€step.1.3ã€‘é‡åˆ°éæ³•åŒ…ç±»å‹ç›´æ¥é€€å‡º</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">!=</span> IKCP_CMD_PUSH <span class="token operator">&amp;&amp;</span> cmd <span class="token operator">!=</span> IKCP_CMD_ACK <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			cmd <span class="token operator">!=</span> IKCP_CMD_WASK <span class="token operator">&amp;&amp;</span> cmd <span class="token operator">!=</span> IKCP_CMD_WINS <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			cmd <span class="token operator">!=</span> IKCP_CMD_UNRELIABLE<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">//ã€step.1.4ã€‘è®¾ç½®è¿œç«¯çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        kcp<span class="token operator">-></span>rmt_wnd <span class="token operator">=</span> wnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">//ã€step.1.5ã€‘æ ¹æ®è¿œç«¯å‘æ¥çš„ç¬¬ä¸€ä¸ªæœªæ”¶åŒ…ç¼–å·</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// è¯´æ˜æœªæ”¶åŒ…ä¹‹å‰çš„åŒ…ä½“éƒ½æ”¶åˆ°äº†ï¼Œæ¸…ç†æœ¬åœ°åŒ…ç¼“å­˜</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">ikcp_parse_una</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> una<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">//ã€step.1.6ã€‘æ›´æ–°æœ¬åœ°çš„æœªæ”¶åŒ…ç¼–å·</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// å¦‚æœç¼“å­˜å†…æ²¡æœ‰åŒ…ä½“ï¼Œé‚£ä¹ˆç¼–å·ä¸ºå‘é€åŒ… + 1ï¼Œå¦åˆ™ä¸ºæœ€æ—©çš„ç¼“å­˜åŒ…</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">ikcp_shrink_buf</span><span class="token punctuation">(</span>kcp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token comment">//ã€step.1.7ã€‘å¤„ç† ACK åŒ…</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> IKCP_CMD_ACK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">//ã€step.1.7.1ã€‘é€šè¿‡å‘åŒ…åˆ° ack æ—¶é—´å·®è¯„ä¼°ç½‘ç»œçŠ¶å†µè°ƒæ•´ç›¸åº”çš„å‚æ•°</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token function">ikcp_update_ack</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> <span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>current<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            </pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">//ã€step.1.7.2ã€‘æ¸…ç†æœ¬åœ°å·²å‘åŒ…ç¼“å­˜å’Œæœªæ”¶åŒ…ç¼–å·</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			<span class="token function">ikcp_parse_ack</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> sn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token function">ikcp_shrink_buf</span><span class="token punctuation">(</span>kcp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">//ã€step.1.7.3ã€‘è®°å½•æœ€å¤§çš„ ack åŒ…ç¼–å·</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">//ã€step.1.8ã€‘å¤„ç†å¯¹ç«¯æ•°æ®åŒ…</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> IKCP_CMD_PUSH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>			<span class="token comment">//ã€step.1.8.1ã€‘æœ¬åœ°çª—å£è¿˜èƒ½å®¹çº³åŒ…æ•°æ®æƒ…å†µä¸‹ï¼Œè§£åŒ…ï¼Œå¦åˆ™ç›´æ¥ä¸¢å¼ƒ</span></pre></td></tr><tr><td data-num="42"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>sn<span class="token punctuation">,</span> kcp<span class="token operator">-></span>rcv_nxt <span class="token operator">+</span> kcp<span class="token operator">-></span>rcv_wnd<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token comment">//ã€step.1.8.2ã€‘æ›´æ–° ack_list å†…çš„ä¿¡æ¯</span></pre></td></tr><tr><td data-num="44"></td><td><pre>				<span class="token function">ikcp_ack_push</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> sn<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                </pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token comment">//ã€step.1.8.3ã€‘å¦‚æœæ˜¯ä¹‹å‰æ²¡æ”¶åˆ°çš„åŒ… sn > kcp->rcv_nxt</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token comment">// åˆ›å»ºåŒ…ç»“æ„ï¼Œå¹¶ä¸¢åˆ° rev_buf é‡Œé¢ï¼ˆæ— åºçš„ï¼‰</span></pre></td></tr><tr><td data-num="48"></td><td><pre>				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>sn<span class="token punctuation">,</span> kcp<span class="token operator">-></span>rcv_nxt<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>					<span class="token comment">// åˆå§‹åŒ– segment åŒ…å¤´</span></pre></td></tr><tr><td data-num="50"></td><td><pre>					<span class="token function">ikcp_parse_data</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> seg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">//ã€step.1.9ã€‘å¤„ç†å¯¹ç«¯è¯·æ±‚çª—å£å¤§å°åŒ…</span></pre></td></tr><tr><td data-num="55"></td><td><pre>		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> IKCP_CMD_WASK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>			<span class="token comment">// æ ‡è®°ä¸€ä¸‹ï¼Œä¸‹æ¬¡ flush çš„æ—¶å€™éœ€è¦å›å¤æœ¬ç«¯çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="57"></td><td><pre>			kcp<span class="token operator">-></span>probe <span class="token operator">|=</span> IKCP_ASK_TELL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">//ã€step.1.10ã€‘å¯¹ç«¯æ”¶åˆ°äº†æœ¬åœ°é€šçŸ¥çš„çª—å£å¤§å°åçš„å›åŒ…ï¼Œä¸åšå¤„ç†</span></pre></td></tr><tr><td data-num="60"></td><td><pre>		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> IKCP_CMD_WINS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>			<span class="token comment">// do nothing...</span></pre></td></tr><tr><td data-num="62"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token comment">//ã€step.1.11ã€‘æ”¶åˆ°äº†éå¯é åŒ…ï¼Œä¸éœ€è¦è®°å½•åœ¨ ack_list ä¹Ÿä¸ç”¨æ¸…ç†ç¼“å­˜ç›´æ¥è§£å®Œä¸¢ rev_buff é‡Œ</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> IKCP_CMD_UNRELIABLE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>			<span class="token comment">// ...</span></pre></td></tr><tr><td data-num="66"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">//ã€step.2ã€‘æ ¹æ®æœ€å¤§æœªæ”¶åŒ…ç¼–å·ï¼Œæ›´æ–°ä¹‹å‰çš„æœªæ”¶åŒ…çš„ä¸¢åŒ…æ¬¡æ•°ï¼Œç”¨äºå¿«é€Ÿé‡ä¼ </span></pre></td></tr><tr><td data-num="72"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>		<span class="token function">ikcp_parse_fastack</span><span class="token punctuation">(</span>kcp<span class="token punctuation">,</span> maxack<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">//ã€step.3ã€‘æ‹¥å¡æ§åˆ¶</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">// ä¹‹å‰çš„æœªæ”¶åŒ…ï¼Œåœ¨æœ¬æ¬¡ ack åï¼Œæœ‰äº›æ”¶åˆ°äº†ï¼Œè¯´æ˜æ•°æ®æ­£å¸¸é€è¾¾äº†</span></pre></td></tr><tr><td data-num="78"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>snd_una<span class="token punctuation">,</span> una<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token comment">// ã€step.3.1ã€‘å¦‚æœæ‹¥å¡çª—å£å°äºå¯¹ç«¯å¯æ¥æ”¶å¤§å°ï¼Œè¿›å…¥æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶</span></pre></td></tr><tr><td data-num="80"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">&lt;</span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>			<span class="token comment">// ...</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token comment">//ã€step.3.1.1ã€‘å½“å‰æ‹¥å¡çª—å£å°äºé˜ˆå€¼ï¼Œå‡†å¤‡æ…¢å¯åŠ¨æ‰©å¼ æ‹¥å¡çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="83"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">&lt;</span> kcp<span class="token operator">-></span>ssthresh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>				kcp<span class="token operator">-></span>cwnd<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>				kcp<span class="token operator">-></span>incr <span class="token operator">+=</span> mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>			<span class="token comment">//ã€step.3.1.2ã€‘å½“å‰å¯å‘é€æ•°æ®å°äºä¸€ä¸ªåˆ†ç‰‡å¤§å°ï¼Œæ‰©å¼ å‘åŒ…å¤§å°å’Œæ‹¥å¡çª—å£å¤§å°</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>				<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>incr <span class="token operator">&lt;</span> mss<span class="token punctuation">)</span> kcp<span class="token operator">-></span>incr <span class="token operator">=</span> mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>				kcp<span class="token operator">-></span>incr <span class="token operator">+=</span> <span class="token punctuation">(</span>mss <span class="token operator">*</span> mss<span class="token punctuation">)</span> <span class="token operator">/</span> kcp<span class="token operator">-></span>incr <span class="token operator">+</span> <span class="token punctuation">(</span>mss <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> mss <span class="token operator">&lt;=</span> kcp<span class="token operator">-></span>incr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>					kcp<span class="token operator">-></span>cwnd<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token comment">//ã€step.3.1.3ã€‘å¦‚æœæ‹¥å¡çª—å£å¤§äºé˜ˆå€¼ï¼Œé™åˆ¶çª—å£å¤§å°å’Œå‘åŒ…å¤§å°</span></pre></td></tr><tr><td data-num="95"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">></span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>				kcp<span class="token operator">-></span>cwnd <span class="token operator">=</span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>				kcp<span class="token operator">-></span>incr <span class="token operator">=</span> kcp<span class="token operator">-></span>rmt_wnd <span class="token operator">*</span> mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="ikcp_recv"><a class="anchor" href="#ikcp_recv">#</a> ikcp_recv</h3><p>æ‰¹é‡è¯»å– <code>rev_queue</code> å†…æŒ‰ç…§ <code>sn</code> é¡ºåºç¼–æ’çš„åŒ…ï¼š</p><ul><li>å…ˆå¯¹åŒä¸€ç»„ <code>frg</code> çš„åŒ…è¿›è¡Œè¯»å–ï¼Œè¯»åˆ° <code>frg = 0</code> çš„æƒ…å†µä¸‹åœæ­¢ï¼ˆåˆåŒ…å¤„ç†ï¼‰</li><li>æŠŠæ‰€æœ‰æ•°æ®åˆå¹¶åˆ° <code>buff</code> å†…ï¼Œå¹¶åœ¨åšä¸€æ¬¡ <code>rev_buf -&gt; rev_queue</code> çš„æ’åºå’Œç§»åŠ¨</li><li>åˆ¤æ–­ <code>recover</code> ï¼Œæ‰“ä¸Šæ ‡è®°ç”¨äºä¸‹æ¬¡ <code>ikcp_flush</code> é€šçŸ¥å¯¹ç«¯çª—å£å¤§å°ï¼Œå‡å°‘é˜»å¡æ—¶é—´</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// user/upper level recv: returns size, returns below zero for EAGAIN</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">ikcp_recv</span><span class="token punctuation">(</span>ikcpcb <span class="token operator">*</span>kcp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">// ã€step.1ã€‘è®¡ç®—ä¸€ä¸‹è¯»å–æ•°æ®å¤§å°</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// ã€step.1.1ã€‘è¯»åˆ°ä¸‹ä¸€ä¸ª frg = 0 åŒ…å†…æ‰€æœ‰ data å¤§å°çš„æ€»å’Œï¼ˆä¸åŒ…æ‹¬åŒ…å¤´ï¼‰</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	peeksize <span class="token operator">=</span> <span class="token function">ikcp_peeksize</span><span class="token punctuation">(</span>kcp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">// ã€step.1.2ã€‘åˆ¤æ–­ä¸€å †è¾¹ç•Œæƒ…å†µ</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// ã€step.1.3ã€‘å¦‚æœä¹‹å‰æ”¶åŒ…é˜Ÿåˆ—æ»¡äº†ï¼Œè¡¨ç¤ºå¯¹ç«¯ä¸ä¼šå†å‘æ•°æ®äº†ã€‚</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// éœ€è¦æ ‡è®°ä¸€ä¸‹ï¼Œåé¢é€šçŸ¥å¯¹ç«¯æ–°çš„çª—å£ï¼Œè®©å¯¹ç«¯èƒ½å¤Ÿç»§ç»­å‘é€æ•°æ®</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>nrcv_que <span class="token operator">>=</span> kcp<span class="token operator">-></span>rcv_wnd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		recover <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// ã€step.2ã€‘è¯»å–æ•°æ®</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">//merge fragmentï¼ˆåˆåŒ…ï¼‰ï¼ŒæŒ‰ç…§ data block ä¸ºå•ä½è¿›è¡Œè¯»å–ï¼Œè¯»åˆ° frg = 0 åœæ­¢</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> kcp<span class="token operator">-></span>rcv_queue<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token operator">&amp;</span>kcp<span class="token operator">-></span>rcv_queue<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token comment">// è¯»å–æ•°æ®</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// ã€step.3ã€‘å¯¹ rev_buf æ’åºååŠ å…¥åˆ° rev_queue</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// ç”±äºè¯»å–äº†ä¸€äº› rev_queue å†…å®¹ï¼Œå› æ­¤å¯ä»¥å†ä» rev_buf æŒªä¸€éƒ¨åˆ†è¿‡æ¥</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">iqueue_is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kcp<span class="token operator">-></span>rcv_buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token comment">// move available data from rcv_buf -> rcv_queue</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token comment">// ã€step.4ã€‘æ‰“ä¸Šé€šçŸ¥å¯¹ç«¯çª—å£å¤§å°çš„æ ‡è®°</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>nrcv_que <span class="token operator">&lt;</span> kcp<span class="token operator">-></span>rcv_wnd <span class="token operator">&amp;&amp;</span> recover<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token comment">// ready to send back IKCP_CMD_WINS in ikcp_flush</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token comment">// tell remote my window size</span></pre></td></tr><tr><td data-num="35"></td><td><pre>		kcp<span class="token operator">-></span>probe <span class="token operator">|=</span> IKCP_ASK_TELL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token keyword">return</span> sz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="è§„åˆ™æ±‡æ€»"><a class="anchor" href="#è§„åˆ™æ±‡æ€»">#</a> è§„åˆ™æ±‡æ€»</h2><p>Kcp çš„å‘åŒ…æœ‰å¾ˆå¤šç»†èŠ‚çš„è§„åˆ™ï¼Œè¿™é‡Œåšä¸€ä¸ªæ¢³ç†ï¼Œå¹¶è¿›ä¸€æ­¥çš„è§£é‡Š</p><h3 id="streamæ¨¡å¼å’Œéstreamæ¨¡å¼"><a class="anchor" href="#streamæ¨¡å¼å’Œéstreamæ¨¡å¼">#</a> ã€ŒStreamã€æ¨¡å¼å’Œã€Œé Streamã€æ¨¡å¼</h3><p>kcp æ”¯æŒä¸¤ç§æ¨¡å¼çš„å‘åŒ…ï¼š</p><h4 id="stream"><a class="anchor" href="#stream">#</a> Stream</h4><p>å‡è®¾å›¾ä¸­æ¯ä¸ª <code>data block</code> éƒ½æ¥è‡ªä¸åŒåº”ç”¨å±‚çš„æ•°æ®åŒ…</p><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220222171736.png" alt="image-20220222171735081"></p><h4 id="éstream"><a class="anchor" href="#éstream">#</a> é Stream</h4><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220222171941.png" alt="image-20220222171940486"></p><ul><li>ã€ŒStreamã€æ¨¡å¼æƒ…å†µä¸‹ï¼Œ <code>data block</code> çš„æ•°æ®æ˜¯å¯ä»¥åˆ†æ®µè¯»å–æ¯ä¸ª <code>data</code></li><li>ã€Œé Streamã€æ¨¡å¼çš„è§£åŒ…å¿…é¡»ä¸€æ¬¡æ€§è§£å‡ºæ•´ä¸ª <code>data block</code></li><li>ã€ŒStreamã€æ¨¡å¼æƒ…å†µä¸‹ï¼Œå¤šä¸ª <code>data block</code> å¯ä»¥æ‹¼æ¥åœ¨ä¸€èµ·è¿›è¡Œå‘é€ï¼Œå› æ­¤ <code>data block 2</code> å†…çš„éƒ¨åˆ†æ•°æ®å¯ä»¥è¢«æ‹†åˆ†åˆ°ç¬¬ä¸€ä¸ªä¼ è¾“å•å…ƒå†…ï¼Œä½†æ˜¯ã€Œé Streamã€ä¸æ”¯æŒè¯¥æ“ä½œï¼Œä¼šå¯¹å•ä¸ª <code>data block</code> è¿›è¡Œè£…åŒ…ã€‚</li></ul><h4 id="å¦‚ä½•è§£å‡ºæ‹¼æ¥è¿‡çš„æ•°æ®"><a class="anchor" href="#å¦‚ä½•è§£å‡ºæ‹¼æ¥è¿‡çš„æ•°æ®">#</a> å¦‚ä½•è§£å‡ºæ‹¼æ¥è¿‡çš„æ•°æ®ï¼Ÿ</h4><p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦è¯»å–è“è‰²æ–¹å—çš„æ•°æ®</p><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220222172715.png" alt="image-20220222172714830"></p><ul><li>å‡è®¾ç¬¬ä¸€ä¸ªåŒ…æ•°æ®æ¥äº†ï¼Œä½†æ˜¯æ•°æ®æœ‰ç‚¹å°‘ï¼Œè¿˜ä¸è¶³ä¸€ä¸ªåŒ…å¤´ï¼Œé‚£ä¹ˆå…ˆå­˜ç€ï¼Œç­‰ä¸‹ä¸€ä¸ªåŒ…ã€‚</li><li>ä¸‹ä¸ªåŒ…æ¥äº†ï¼Œå‘ç°å¯ä»¥è§£å‡ºåŒ…å¤´äº†ï¼Œä½†æ˜¯åé¢çš„æ•°æ®è¿˜å°‘äº†ï¼Œå†ç­‰ä¸‹ä¸€ä¸ªåŒ…ã€‚</li><li>ä¸‹ä¸ªåŒ…æ¥äº†ï¼Œæ•°æ®ä¹Ÿå¤Ÿäº†ï¼Œæ‰å¼€å§‹è¿›è¡Œè§£åŒ…ã€‚</li></ul><blockquote><p>è¿™é‡Œçš„ <code>data head</code> å’Œ <code>data len</code> å·²ç»æ˜¯ä¸šåŠ¡å±‚é¢çš„è§„åˆ™äº†ï¼Œå¹¶é <code>kcp</code> éƒ¨åˆ†ï¼Œå®ç°ä¸Šå¯ä»¥æŒ‰ç…§å®é™…æƒ…å†µæ¥</p></blockquote><h3 id="å¿«é€Ÿé‡ä¼ -è¶…æ—¶é‡ä¼ "><a class="anchor" href="#å¿«é€Ÿé‡ä¼ -è¶…æ—¶é‡ä¼ ">#</a> å¿«é€Ÿé‡ä¼  | è¶…æ—¶é‡ä¼ </h3><ul><li>å¿«é€Ÿé‡ä¼ ï¼šåç»­åŒ…æ”¶åˆ°äº†ï¼Œä½†æ˜¯å‰é¢çš„åŒ…æ²¡æ”¶åˆ°ï¼Œå°±ä¼šè§¦å‘å¿«é€Ÿé‡ä¼ </li><li>è¶…æ—¶é‡ä¼ ï¼šæ•°æ®åŒ…å‘é€åä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° <code>ack</code> å›å¤ï¼Œå°±ä¼šè§¦å‘è¶…æ—¶é‡ä¼ </li></ul><h3 id="åˆåŒ…è§„åˆ™"><a class="anchor" href="#åˆåŒ…è§„åˆ™">#</a> åˆåŒ…è§„åˆ™</h3><p>åˆåŒ…å…¶å®æœ¬è´¨ä¸Šæ˜¯å‡å°‘å‘åŒ…æ¬¡æ•°ï¼Œå°½å¯èƒ½åˆ©ç”¨å¸¦å®½</p><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220222174043.png" alt="image-20220222174042490"></p><h3 id="æ»‘åŠ¨çª—å£"><a class="anchor" href="#æ»‘åŠ¨çª—å£">#</a> æ»‘åŠ¨çª—å£</h3><p><img data-src="https://blog-1255596461.cos.ap-guangzhou.myqcloud.com/blog_pic/20220222180213.png" alt="image-20220222180212342"></p><h3 id="æ…¢å¯åŠ¨-æ‹¥å¡çª—å£"><a class="anchor" href="#æ…¢å¯åŠ¨-æ‹¥å¡çª—å£">#</a> æ…¢å¯åŠ¨ | æ‹¥å¡çª—å£</h3><p>æ…¢å¯åŠ¨æœ¬è´¨æ˜¯ä¸ºäº†åœ¨ä¸¥é‡ä¸¢åŒ…ç½‘ç»œç¯å¢ƒä¸‹ï¼Œå¦‚æœç½‘ç»œå‘ç”Ÿå¥½è½¬åï¼Œä¸€ç‚¹ç‚¹æ”¾å¼€å‘é€çª—å£å¤§å°ï¼Œå¢åŠ æ¯æ¬¡å‘é€çš„æ•°æ®é‡</p><p>æ…¢å¯åŠ¨çš„å®ç°ä¸€èˆ¬æ˜¯é€šè¿‡æ§åˆ¶æ‹¥å¡çª—å£å¤§å°ï¼Œè¿›è€Œæ§åˆ¶å‘åŒ…æ•°é‡ã€‚</p><p>æ¯æ¬¡æ‰§è¡Œ <code>ikcp_input</code> æ“ä½œè·å–æ¥å—åŒ…æ—¶ï¼Œå¦‚æœå‘ç°ä¹‹å‰å‘é€çš„åŒ…è¢«å¯¹ç«¯ <code>ack</code> åï¼ˆ <code>snd_una</code> å˜äº†ï¼‰ï¼Œä¼šå°è¯•æ‰©å¤§æ‹¥å¡çª—å£å¤§å°ï¼š</p><ul><li>å¦‚æœæ²¡æœ‰è¶…è¿‡é˜ˆå€¼çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡ <code>+1</code></li><li>å¦‚æœè¶…è¿‡é˜ˆå€¼åï¼Œæ¯æ¬¡å¢åŠ  <code>1/ikcp_incr + 1/16</code> ï¼Œå¦‚æœå˜åŒ–åä¸‹å–æ•´èƒ½å¤Ÿå¤šå‡ºä¸€ä¸ªå•ä½ï¼Œåˆ™çª—å£ <code>+1</code></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_itimediff</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>snd_una<span class="token punctuation">,</span> una<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">&lt;</span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        IUINT32 mss <span class="token operator">=</span> kcp<span class="token operator">-></span>mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">&lt;</span> kcp<span class="token operator">-></span>ssthresh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            kcp<span class="token operator">-></span>cwnd<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            kcp<span class="token operator">-></span>incr <span class="token operator">+=</span> mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span>	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>incr <span class="token operator">&lt;</span> mss<span class="token punctuation">)</span> kcp<span class="token operator">-></span>incr <span class="token operator">=</span> mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            kcp<span class="token operator">-></span>incr <span class="token operator">+=</span> <span class="token punctuation">(</span>mss <span class="token operator">*</span> mss<span class="token punctuation">)</span> <span class="token operator">/</span> kcp<span class="token operator">-></span>incr <span class="token operator">+</span> <span class="token punctuation">(</span>mss <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> mss <span class="token operator">&lt;=</span> kcp<span class="token operator">-></span>incr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                kcp<span class="token operator">-></span>cwnd<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>cwnd <span class="token operator">></span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            kcp<span class="token operator">-></span>cwnd <span class="token operator">=</span> kcp<span class="token operator">-></span>rmt_wnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            kcp<span class="token operator">-></span>incr <span class="token operator">=</span> kcp<span class="token operator">-></span>rmt_wnd <span class="token operator">*</span> mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¦‚æœç½‘ç»œç¯å¢ƒçªç„¶å¼‚å¸¸ â€”â€” å‡ºç°ä¸¢åŒ…ï¼ˆè¶…æ—¶é‡ä¼ ï¼‰ | é“¾è·¯åˆ‡æ¢å¯¼è‡´ä¹±åºï¼ˆå¿«é€Ÿé‡ä¼ ï¼‰ï¼Œä¹Ÿä¼šé€šè¿‡æ‹¥å¡çª—å£å‡å°‘å‘åŒ…æ•°é‡é¿å…æ— è°“çš„è¶…æ—¶é‡ä¼ ï¼š</p><ul><li>å‡ºç°ä¸¢åŒ…ï¼šè¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½ç½‘ç»œç›´æ¥å°±ä¸å¥½ç”¨äº†ï¼Œå‘éƒ½å‘ä¸è¿‡å»ï¼Œç›´æ¥æŠŠæ‹¥å¡çª—å£è®¾ç½®ä¸º <code>1</code> ï¼Œå¼ºè¡Œé™æµã€‚</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>lost<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    kcp<span class="token operator">-></span>ssthresh <span class="token operator">=</span> cwnd <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>ssthresh <span class="token operator">&lt;</span> IKCP_THRESH_MIN<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        kcp<span class="token operator">-></span>ssthresh <span class="token operator">=</span> IKCP_THRESH_MIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    kcp<span class="token operator">-></span>cwnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    kcp<span class="token operator">-></span>incr <span class="token operator">=</span> kcp<span class="token operator">-></span>mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>å‡ºç°ä¹±åºï¼šç½‘ç»œæ³¢åŠ¨æ¯”è¾ƒå¤§ï¼Œé¢‘ç¹é“¾è·¯åˆ‡æ¢æˆ–è€…å…¶ä»–å› ç´ å¯¼è‡´ä¹±åºï¼Œé€‚å½“çš„é™ä½çª—å£å¤§å°ï¼š<ul><li>æ‹¥å¡çª—å£é˜ˆå€¼ <code>ssthresh</code> å‡åŠï¼Œæ‹¥å¡çª—å£è°ƒæ•´ä¸º <code>ssthresh + resent(è¡¨ç¤ºæ”¶åˆ°çš„ä¹±åºåŒ…æ•°é‡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç­‰äº fastack)</code></li></ul></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    IUINT32 inflight <span class="token operator">=</span> kcp<span class="token operator">-></span>snd_nxt <span class="token operator">-</span> kcp<span class="token operator">-></span>snd_una<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    kcp<span class="token operator">-></span>ssthresh <span class="token operator">=</span> inflight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>kcp<span class="token operator">-></span>ssthresh <span class="token operator">&lt;</span> IKCP_THRESH_MIN<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        kcp<span class="token operator">-></span>ssthresh <span class="token operator">=</span> IKCP_THRESH_MIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    kcp<span class="token operator">-></span>cwnd <span class="token operator">=</span> kcp<span class="token operator">-></span>ssthresh <span class="token operator">+</span> resent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    kcp<span class="token operator">-></span>incr <span class="token operator">=</span> kcp<span class="token operator">-></span>cwnd <span class="token operator">*</span> kcp<span class="token operator">-></span>mss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/kcp/" rel="tag"><i class="ic i-tag"></i> kcp</a> <a href="/tags/net/" rel="tag"><i class="ic i-tag"></i> net</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-12-29 09:36:04" itemprop="dateModified" datetime="2022-12-29T09:36:04+08:00">2022-12-29</time> </span><span id="learning/network/kcpæºç é˜…è¯»/" class="item leancloud_visitors" data-flag-title="kcpæºç é˜…è¯»" title="é˜…è¯»æ¬¡æ•°"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">é˜…è¯»æ¬¡æ•°</span> <span class="leancloud-visitors-count"></span> <span class="text">æ¬¡</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> å……ç”µ</button><p>è¯·æˆ‘[æ°é¥­]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="é‘«é…±(â—'â—¡'â—) å¾®ä¿¡æ”¯ä»˜"><p>å¾®ä¿¡æ”¯ä»˜</p></div><div><img data-src="/images/alipay.png" alt="é‘«é…±(â—'â—¡'â—) æ”¯ä»˜å®"><p>æ”¯ä»˜å®</p></div></div></div><div id="copyright"><ul><li class="author"><strong>æœ¬æ–‡ä½œè€…ï¼š </strong>é‘«é…±(â—'â—¡'â—) <i class="ic i-at"><em>@</em></i>é‘«é…±</li><li class="link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong> <a href="https://hakuya.me/learning/network/kcp%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="kcpæºç é˜…è¯»">https://hakuya.me/learning/network/kcpæºç é˜…è¯»/</a></li><li class="license"><strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/learning/linux/asio%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;wallpaper-1255596461.cos.ap-nanjing.myqcloud.com&#x2F;wallpaper (23).jpg" title="asioæºç é˜…è¯»"><span class="type">ä¸Šä¸€ç¯‡</span> <span class="category"><i class="ic i-flag"></i> linux</span><h3>asioæºç é˜…è¯»</h3></a></div><div class="item right"><a href="/learning/physx/PhysX%E5%86%85%E7%BD%AE%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;wallpaper-1255596461.cos.ap-nanjing.myqcloud.com&#x2F;wallpaper_2.jpg" title="PhysXå†…ç½®å®¹å™¨ä»‹ç»"><span class="type">ä¸‹ä¸€ç¯‡</span> <span class="category"><i class="ic i-flag"></i> ç‰©ç†å¼•æ“</span><h3>PhysXå†…ç½®å®¹å™¨ä»‹ç»</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="æ–‡ç« ç›®å½•"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kcp%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="toc-number">1.</span> <span class="toc-text">kcp æºç é˜…è¯»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B6%E5%8F%91%E5%8C%85%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">æ”¶å‘åŒ…æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">ç›¸å…³æ•°æ®ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kcp%E5%8C%85%E5%A4%B4"><span class="toc-number">1.2.1.</span> <span class="toc-text">Kcp åŒ…å¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0kcp-segment%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">æœ¬åœ° Kcp Segment ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kcp-%E5%AF%B9%E8%B1%A1%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.3.</span> <span class="toc-text">Kcp å¯¹è±¡æ•°æ®ç»“æ„</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.</span> <span class="toc-text">æ ¸å¿ƒæ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ikcp_create"><span class="toc-number">1.3.1.</span> <span class="toc-text">ikcp_create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ikcp_setoutput-kcp-output-ikcp_output"><span class="toc-number">1.3.2.</span> <span class="toc-text">ikcp_setoutput | kcp-&gt;output | ikcp_output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ikcp_update"><span class="toc-number">1.3.3.</span> <span class="toc-text">ikcp_update</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ikcp_flush"><span class="toc-number">1.3.4.</span> <span class="toc-text">ikcp_flush</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ikcp_input"><span class="toc-number">1.3.5.</span> <span class="toc-text">ikcp_input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ikcp_recv"><span class="toc-number">1.3.6.</span> <span class="toc-text">ikcp_recv</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E6%B1%87%E6%80%BB"><span class="toc-number">1.4.</span> <span class="toc-text">è§„åˆ™æ±‡æ€»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stream%E6%A8%A1%E5%BC%8F%E5%92%8C%E9%9D%9Estream%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.</span> <span class="toc-text">ã€ŒStreamã€æ¨¡å¼å’Œã€Œé Streamã€æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#stream"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Stream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9Estream"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">é Stream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%87%BA%E6%8B%BC%E6%8E%A5%E8%BF%87%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">å¦‚ä½•è§£å‡ºæ‹¼æ¥è¿‡çš„æ•°æ®ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0-%E8%B6%85%E6%97%B6%E9%87%8D%E4%BC%A0"><span class="toc-number">1.4.2.</span> <span class="toc-text">å¿«é€Ÿé‡ä¼  | è¶…æ—¶é‡ä¼ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%88%E5%8C%85%E8%A7%84%E5%88%99"><span class="toc-number">1.4.3.</span> <span class="toc-text">åˆåŒ…è§„åˆ™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="toc-number">1.4.4.</span> <span class="toc-text">æ»‘åŠ¨çª—å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E5%90%AF%E5%8A%A8-%E6%8B%A5%E5%A1%9E%E7%AA%97%E5%8F%A3"><span class="toc-number">1.4.5.</span> <span class="toc-text">æ…¢å¯åŠ¨ | æ‹¥å¡çª—å£</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="ç³»åˆ—æ–‡ç« "><ul><li class="active"><a href="/learning/network/kcp%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="bookmark" title="kcpæºç é˜…è¯»">kcpæºç é˜…è¯»</a></li></ul></div><div class="overview panel" data-title="ç«™ç‚¹æ¦‚è§ˆ"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="é‘«é…±(â—'â—¡'â—)" data-src="/images/avatar.jpg"><p class="name" itemprop="name">é‘«é…±(â—'â—¡'â—)</p><div class="description" itemprop="description">æ•´å¤©æ‘¸é±¼ï¼Œå´å¦„æƒ³æ‹¯æ•‘ä¸–ç•Œçš„æŠ€æœ¯å®…</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">110</span> <span class="name">æ–‡ç« </span></a></div><div class="item categories"><a href="/categories/"><span class="count">25</span> <span class="name">åˆ†ç±»</span></a></div><div class="item tags"><a href="/tags/"><span class="count">67</span> <span class="name">æ ‡ç­¾</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FsbGVuR1g=" title="https:&#x2F;&#x2F;github.com&#x2F;AllenGX"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTgwNTM4MjQy" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;80538242"><i class="ic i-cloud-music"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjE0MTM5MDcxNTNAcXEuY29t" title="mailto:1413907153@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>é¦–é¡µ</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>å…³äº</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>æ–‡ç« </a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>å½’æ¡£</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>åˆ†ç±»</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>æ ‡ç­¾</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>å¥½å‹</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>ç½‘å€</a></li><li class="item"><a href="/travellings/" rel="section"><i class="ic i-paper-plane"></i>ä¼ é€é—¨</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>Mikutap</a></li><li class="item"><a href="/restart/" rel="section"><i class="ic i-sun"></i>RestartLife</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/learning/linux/asio%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="prev" title="ä¸Šä¸€ç¯‡"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/learning/physx/PhysX%E5%86%85%E7%BD%AE%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/" rel="next" title="ä¸‹ä¸€ç¯‡"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>éšæœºæ–‡ç« </h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/japanese/" title="åˆ†ç±»äº æ—¥è¯­">æ—¥è¯­</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/japanese/primary/" title="åˆ†ç±»äº æ—¥è¯­åˆçº§">æ—¥è¯­åˆçº§</a></div><span><a href="/learning/japanese/primary/%E5%8D%81%E4%BA%8C%E3%80%81%E5%B0%8F%E6%9D%8E%E6%AF%94%E5%B0%8F%E6%A3%AE%E5%B9%B4%E8%BD%BB/" title="åäºŒã€å°ææ¯”å°æ£®å¹´è½»">åäºŒã€å°ææ¯”å°æ£®å¹´è½»</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game101/" title="åˆ†ç±»äº Games101å›¾å½¢æ¸²æŸ“">Games101å›¾å½¢æ¸²æŸ“</a></div><span><a href="/learning/games/Game101/%E4%BA%8C%E5%8D%81%E5%9B%9B%E3%80%81Animation%EF%BC%88%E4%B8%8B%EF%BC%89/" title="äºŒåå››ã€Animationï¼ˆä¸‹ï¼‰">äºŒåå››ã€Animationï¼ˆä¸‹ï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game101/" title="åˆ†ç±»äº Games101å›¾å½¢æ¸²æŸ“">Games101å›¾å½¢æ¸²æŸ“</a></div><span><a href="/learning/games/Game101/%E4%BA%8C%E3%80%81Transformation/" title="äºŒã€Transformation">äºŒã€Transformation</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game101/" title="åˆ†ç±»äº Games101å›¾å½¢æ¸²æŸ“">Games101å›¾å½¢æ¸²æŸ“</a></div><span><a href="/learning/games/Game101/%E4%B8%83%E3%80%81Shading%EF%BC%88%E4%B8%8A%EF%BC%89%E2%80%94%E2%80%94Light/" title="ä¸ƒã€Shadingï¼ˆä¸Šï¼‰â€”â€”Light">ä¸ƒã€Shadingï¼ˆä¸Šï¼‰â€”â€”Light</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/unreal/" title="åˆ†ç±»äº UE">UE</a></div><span><a href="/learning/unreal/Unreal%20Replication%20%E7%AF%87/" title="Unreal ReplicationGraph ç¯‡">Unreal ReplicationGraph ç¯‡</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/physx/" title="åˆ†ç±»äº ç‰©ç†å¼•æ“">ç‰©ç†å¼•æ“</a></div><span><a href="/learning/physx/PhysX%E2%80%94%E2%80%94GJK%20&&%20EPA/" title="PhysXâ€”â€”GJK &amp;&amp; EPA">PhysXâ€”â€”GJK && EPA</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game101/" title="åˆ†ç±»äº Games101å›¾å½¢æ¸²æŸ“">Games101å›¾å½¢æ¸²æŸ“</a></div><span><a href="/learning/games/Game101/%E5%8D%81%E4%B9%9D%E3%80%81Advanced%20Topics%20in%20Rendering%E2%80%94%E2%80%94Light%20Transport/" title="åä¹ã€Advanced Topics in Renderingâ€”â€”Light Transport">åä¹ã€Advanced Topics in Renderingâ€”â€”Light Transport</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game202/" title="åˆ†ç±»äº GAME202é«˜è´¨é‡å®æ—¶æ¸²æŸ“">GAME202é«˜è´¨é‡å®æ—¶æ¸²æŸ“</a></div><span><a href="/learning/games/Game202/%E4%BA%94%E3%80%81Real-time%20Physically-based%20Materials/" title="äº”ã€Real-time Physically-based Materials">äº”ã€Real-time Physically-based Materials</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game101/" title="åˆ†ç±»äº Games101å›¾å½¢æ¸²æŸ“">Games101å›¾å½¢æ¸²æŸ“</a></div><span><a href="/learning/games/Game101/%E4%B9%9D%E3%80%81Shading%EF%BC%88%E4%B8%8B%EF%BC%89%E2%80%94%E2%80%94Texture%20Mapping%20Cont/" title="ä¹ã€Shadingï¼ˆä¸‹ï¼‰â€”â€”Texture Mapping Cont">ä¹ã€Shadingï¼ˆä¸‹ï¼‰â€”â€”Texture Mapping Cont</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/learning/" title="åˆ†ç±»äº å­¦ä¹ ">å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/" title="åˆ†ç±»äº Gamesç³»åˆ—">Gamesç³»åˆ—</a> <i class="ic i-angle-right"></i> <a href="/categories/learning/games/Game101/" title="åˆ†ç±»äº Games101å›¾å½¢æ¸²æŸ“">Games101å›¾å½¢æ¸²æŸ“</a></div><span><a href="/learning/games/Game101/%E5%8D%81%E4%B8%89%E3%80%81Shadow%20Mapping/" title="åä¸‰ã€Shadow Mapping">åä¸‰ã€Shadow Mapping</a></span></li></ul></div><div><h2>æœ€æ–°è¯„è®º</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">é‘«é…±(â—'â—¡'â—) @ ä¸ªäººåšå®¢</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="ç«™ç‚¹æ€»å­—æ•°">639k å­—</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">9:41</span></div><div class="powered-by">åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"learning/network/kcpæºç é˜…è¯»/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰ã‚„ã‚Œã‚„ã‚Œã ãœ",hide:"(Â´Ğ”ï½€)å¤§å¤‰ã ï¼"},search:{placeholder:"æ–‡ç« æœç´¢",empty:"å…³äº ã€Œ ${query} ã€ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœåˆ°",stats:"${time} ms å†…æ‰¾åˆ° ${hits} æ¡ç»“æœ"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'å¤åˆ¶æˆåŠŸï¼Œè½¬è½½è¯·éµå®ˆ <i class="ic i-creative-commons"></i>BY-NC-SA åè®®ã€‚',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/animejs@3.2.0/lib/anime.min.js,npm/katex@0.12.0/dist/contrib/copy-tex.min.js,npm/frappe-charts@1.5.0/dist/frappe-charts.min.iife.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/quicklink@2/dist/quicklink.umd.js,gh/amehime/MiniValine@4.2.2-beta10/dist/MiniValine.min.js"></script><script src="/js/app.js?v=0.2.5"></script><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b6d809b500bd6f0040117088899bc7bf";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>